"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MongoDbClient = void 0;
const mongoDB = require("mongodb");
const mongodb_error_model_1 = require("../models/error-handling/mongodb-error.model");
class MongoDbClient {
    constructor() {
        this.connectionString = process.env.MONGODB_CONNECTION_STRING;
        this.databaseName = 'lse';
        this.client = new mongoDB.MongoClient(this.connectionString);
    }
    async findOne(collectionName, filter) {
        let result = null;
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            result = await collection.findOne(filter);
            return result;
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, filter=${JSON.stringify(filter)}` });
        }
    }
    async aggregate(collectionName, pipeline) {
        const database = this.client.db(this.databaseName);
        const collection = database.collection(collectionName);
        try {
            const options = { allowDiskUse: true, batchSize: 1000 };
            const result = new Array();
            const cursor = await collection.aggregate(pipeline, options);
            while (await cursor.hasNext()) {
                const doc = await cursor.next();
                if (doc !== null) {
                    result.push(doc);
                }
            }
            cursor.close();
            return result;
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, pipeline=${JSON.stringify(pipeline)}` });
        }
    }
    async findOneById(collectionName, _id) {
        try {
            const objectId = new mongoDB.ObjectId(_id);
            const filter = { _id: objectId };
            return await this.findOne(collectionName, filter);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, _id=${_id}` });
        }
    }
    async find(collectionName, filter, useCursor = false) {
        const database = this.client.db(this.databaseName);
        const collection = database.collection(collectionName);
        try {
            if (useCursor) {
                const options = { allowDiskUse: true, batchSize: 1000 };
                const cursor = await collection.find(filter, options);
                const result = [];
                while (await cursor.hasNext()) {
                    const doc = await cursor.next();
                    if (doc !== null) {
                        result.push(doc);
                    }
                }
                cursor.close();
                return result;
            }
            else {
                const options = { allowDiskUse: false, batchSize: 100 };
                return await collection.find(filter).toArray();
            }
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, filter=${JSON.stringify(filter)}` });
        }
    }
    async insertOne(collectionName, document) {
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            return await collection.insertOne(document);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, document=${JSON.stringify(document)}` });
        }
    }
    async insertMany(collectionName, documents) {
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            return await collection.insertMany(documents);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, documents=${JSON.stringify(documents)}` });
        }
    }
    async deleteOne(collectionName, filter) {
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            return await collection.deleteOne(filter);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, filter=${JSON.stringify(filter)}` });
        }
    }
    async deleteMany(collectionName, filter) {
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            return await collection.deleteMany(filter);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, filter=${JSON.stringify(filter)}` });
        }
    }
    async updateOne(collectionName, filter, update, options) {
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            const set = { $set: update };
            return await collection.updateOne(filter, set, options);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, filter=${JSON.stringify(filter)}, update=${JSON.stringify(update)}${options ? `, options=${JSON.stringify(options)}` : ""}` });
        }
    }
    async updateOneById(collectionName, _id, update, options) {
        const objectId = new mongoDB.ObjectId(_id);
        const filter = { _id: objectId };
        try {
            const database = this.client.db(this.databaseName);
            const collection = database.collection(collectionName);
            const set = { $set: update };
            return await collection.updateOne(filter, set, options);
        }
        catch (error) {
            throw new mongodb_error_model_1.MongoDbError({ message: `${error.message} - collectionName=${collectionName}, filter=${JSON.stringify(filter)}, update=${JSON.stringify(update)}${options ? `, options=${options}` : ""}` });
        }
    }
    async closeConnection() {
        await this.client.close();
    }
}
exports.MongoDbClient = MongoDbClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uZ29kYi5jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zb2Z0d2FyZS9zaGFyZWQvc3JjL2NsaWVudHMvbW9uZ29kYi5jbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLHNGQUE0RTtBQUU1RSxNQUFhLGFBQWE7SUFNdEI7UUFKaUIscUJBQWdCLEdBQVcsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBMEIsQ0FBQztRQUNsRSxpQkFBWSxHQUFXLEtBQUssQ0FBQTtRQUl6QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBa0MsY0FBc0IsRUFBRSxNQUF5QjtRQUV4RixJQUFJLE1BQU0sR0FBNkIsSUFBSSxDQUFDO1FBQzVDLElBQUksQ0FBQztZQUVELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNuRCxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFJLGNBQWMsQ0FBQyxDQUFDO1lBQzFELE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUMsT0FBTyxNQUFNLENBQUM7UUFFbEIsQ0FBQztRQUFDLE9BQU8sS0FBVSxFQUFFLENBQUM7WUFFbEIsTUFBTSxJQUFJLGtDQUFZLENBQUMsRUFBQyxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUMsT0FBTyxxQkFBcUIsY0FBYyxZQUFZLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBQyxDQUFDLENBQUM7UUFFL0gsQ0FBQztJQUVULENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUyxDQUFrQyxjQUFzQixFQUFFLFFBQWlDO1FB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b25nb2RiJztcclxuaW1wb3J0IHsgTW9uZ29EYkVycm9yIH0gZnJvbSAnLi4vbW9kZWxzL2Vycm9yLWhhbmRsaW5nL21vbmdvZGItZXJyb3IubW9kZWwnO1xyXG5cclxuZXhwb3J0IGNsYXNzIE1vbmdvRGJDbGllbnQge1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29ubmVjdGlvblN0cmluZzogc3RyaW5nID0gcHJvY2Vzcy5lbnYuTU9OR09EQl9DT05ORUNUSU9OX1NUUklORyE7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRhdGFiYXNlTmFtZTogc3RyaW5nID0gJ2xzZSdcclxuICAgIHByaXZhdGUgY2xpZW50OiBtb25nb0RCLk1vbmdvQ2xpZW50O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuY2xpZW50ID0gbmV3IG1vbmdvREIuTW9uZ29DbGllbnQodGhpcy5jb25uZWN0aW9uU3RyaW5nKTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBmaW5kT25lPFQgZXh0ZW5kcyBtb25nb0RCLkJTT04uRG9jdW1lbnQ+KGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsIGZpbHRlcjogbW9uZ29EQi5GaWx0ZXI8VD4pOiBQcm9taXNlPG1vbmdvREIuV2l0aElkPFQ+IHwgbnVsbD4ge1xyXG4gICAgXHJcbiAgICAgICAgICAgIGxldCByZXN1bHQ6IG1vbmdvREIuV2l0aElkPFQ+IHwgbnVsbCA9IG51bGw7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YWJhc2UgPSB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gZGF0YWJhc2UuY29sbGVjdGlvbjxUPihjb2xsZWN0aW9uTmFtZSk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBhd2FpdCBjb2xsZWN0aW9uLmZpbmRPbmUoZmlsdGVyKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcblxyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1vbmdvRGJFcnJvcih7bWVzc2FnZTogYCR7ZXJyb3IubWVzc2FnZX0gLSBjb2xsZWN0aW9uTmFtZT0ke2NvbGxlY3Rpb25OYW1lfSwgZmlsdGVyPSR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyKX1gfSk7XHJcblxyXG4gICAgICAgICAgICB9ICBcclxuICAgIFxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGFnZ3JlZ2F0ZTxUIGV4dGVuZHMgbW9uZ29EQi5CU09OLkRvY3VtZW50Pihjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBwaXBlbGluZTogbW9uZ29EQi5CU09OLkRvY3VtZW50W10pOiBQcm9taXNlPG1vbmdvREIuV2l0aElkPFQ+W10gfCBudWxsPiB7XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgZGF0YWJhc2UgPSB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlTmFtZSk7XHJcbiAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGRhdGFiYXNlLmNvbGxlY3Rpb248VD4oY29sbGVjdGlvbk5hbWUpO1xyXG5cclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9uczogbW9uZ29EQi5GaW5kT3B0aW9ucyA9IHsgYWxsb3dEaXNrVXNlOiB0cnVlLCBiYXRjaFNpemU6IDEwMDAgfVxyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXk8bW9uZ29EQi5XaXRoSWQ8VD4+KCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnNvciA9IGF3YWl0IGNvbGxlY3Rpb24uYWdncmVnYXRlKHBpcGVsaW5lLCBvcHRpb25zKTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHdoaWxlIChhd2FpdCBjdXJzb3IuaGFzTmV4dCgpKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkb2MgPSBhd2FpdCBjdXJzb3IubmV4dCgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkb2MgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChkb2MgYXMgbW9uZ29EQi5XaXRoSWQ8VD4pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjdXJzb3IuY2xvc2UoKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBNb25nb0RiRXJyb3Ioe21lc3NhZ2U6IGAke2Vycm9yLm1lc3NhZ2V9IC0gY29sbGVjdGlvbk5hbWU9JHtjb2xsZWN0aW9uTmFtZX0sIHBpcGVsaW5lPSR7SlNPTi5zdHJpbmdpZnkocGlwZWxpbmUpfWB9KTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIGZpbmRPbmVCeUlkPFQgZXh0ZW5kcyBtb25nb0RCLkJTT04uRG9jdW1lbnQ+KGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsIF9pZDogc3RyaW5nKTogUHJvbWlzZTxtb25nb0RCLldpdGhJZDxUPiB8IG51bGw+IHtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3Qgb2JqZWN0SWQgPSBuZXcgbW9uZ29EQi5PYmplY3RJZChfaWQpO1xyXG4gICAgICAgICAgICBjb25zdCBmaWx0ZXI6IG1vbmdvREIuRmlsdGVyPG1vbmdvREIuQlNPTi5Eb2N1bWVudD4gPSB7IF9pZDogb2JqZWN0SWQgfSBhcyBtb25nb0RCLkZpbHRlcjxtb25nb0RCLkJTT04uRG9jdW1lbnQ+O1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZE9uZTxUPihjb2xsZWN0aW9uTmFtZSwgZmlsdGVyKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgTW9uZ29EYkVycm9yKHttZXNzYWdlOiBgJHtlcnJvci5tZXNzYWdlfSAtIGNvbGxlY3Rpb25OYW1lPSR7Y29sbGVjdGlvbk5hbWV9LCBfaWQ9JHtfaWR9YH0pO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYXN5bmMgZmluZDxUIGV4dGVuZHMgbW9uZ29EQi5CU09OLkRvY3VtZW50Pihjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBmaWx0ZXI6IG1vbmdvREIuRmlsdGVyPG1vbmdvREIuQlNPTi5Eb2N1bWVudD4sIHVzZUN1cnNvcjogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxtb25nb0RCLldpdGhJZDxUPltdPiB7XHJcblxyXG4gICAgICAgIGNvbnN0IGRhdGFiYXNlID0gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZU5hbWUpO1xyXG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBkYXRhYmFzZS5jb2xsZWN0aW9uPFQ+KGNvbGxlY3Rpb25OYW1lKTtcclxuICAgICAgICBcclxuICAgICAgICB0cnkge1xyXG5cclxuICAgICAgICAgICAgaWYgKHVzZUN1cnNvcikge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnM6IG1vbmdvREIuRmluZE9wdGlvbnMgPSB7IGFsbG93RGlza1VzZTogdHJ1ZSwgYmF0Y2hTaXplOiAxMDAwIH07XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgY3Vyc29yID0gYXdhaXQgY29sbGVjdGlvbi5maW5kKGZpbHRlciwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQ6IG1vbmdvREIuV2l0aElkPFQ+W10gPSBbXTtcclxuXHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoYXdhaXQgY3Vyc29yLmhhc05leHQoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvYyA9IGF3YWl0IGN1cnNvci5uZXh0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRvYyAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChkb2MgYXMgbW9uZ29EQi5XaXRoSWQ8VD4pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBjdXJzb3IuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zOiBtb25nb0RCLkZpbmRPcHRpb25zID0geyBhbGxvd0Rpc2tVc2U6IGZhbHNlLCBiYXRjaFNpemU6IDEwMCB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGxlY3Rpb24uZmluZChmaWx0ZXIpLnRvQXJyYXkoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgTW9uZ29EYkVycm9yKHttZXNzYWdlOiBgJHtlcnJvci5tZXNzYWdlfSAtIGNvbGxlY3Rpb25OYW1lPSR7Y29sbGVjdGlvbk5hbWV9LCBmaWx0ZXI9JHtKU09OLnN0cmluZ2lmeShmaWx0ZXIpfWB9KTtcclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBpbnNlcnRPbmU8VCBleHRlbmRzIG1vbmdvREIuQlNPTi5Eb2N1bWVudD4oY29sbGVjdGlvbk5hbWU6IHN0cmluZywgZG9jdW1lbnQ6IG1vbmdvREIuT3B0aW9uYWxVbmxlc3NSZXF1aXJlZElkPFQ+KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFiYXNlID0gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZU5hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gZGF0YWJhc2UuY29sbGVjdGlvbjxUPihjb2xsZWN0aW9uTmFtZSk7XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsZWN0aW9uLmluc2VydE9uZShkb2N1bWVudCk7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBNb25nb0RiRXJyb3Ioe21lc3NhZ2U6IGAke2Vycm9yLm1lc3NhZ2V9IC0gY29sbGVjdGlvbk5hbWU9JHtjb2xsZWN0aW9uTmFtZX0sIGRvY3VtZW50PSR7SlNPTi5zdHJpbmdpZnkoZG9jdW1lbnQpfWB9KTtcclxuXHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBhc3luYyBpbnNlcnRNYW55PFQgZXh0ZW5kcyBtb25nb0RCLkJTT04uRG9jdW1lbnQ+KGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsIGRvY3VtZW50czogbW9uZ29EQi5PcHRpb25hbFVubGVzc1JlcXVpcmVkSWQ8VD5bXSkge1xyXG4gICAgICAgIHRyeSB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRhYmFzZSA9IHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2VOYW1lKTtcclxuICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGRhdGFiYXNlLmNvbGxlY3Rpb248VD4oY29sbGVjdGlvbk5hbWUpO1xyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbGVjdGlvbi5pbnNlcnRNYW55KGRvY3VtZW50cyk7XHJcblxyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBNb25nb0RiRXJyb3Ioe21lc3NhZ2U6IGAke2Vycm9yLm1lc3NhZ2V9IC0gY29sbGVjdGlvbk5hbWU9JHtjb2xsZWN0aW9uTmFtZX0sIGRvY3VtZW50cz0ke0pTT04uc3RyaW5naWZ5KGRvY3VtZW50cyl9YH0pO1xyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGFzeW5jIGRlbGV0ZU9uZShjb2xsZWN0aW9uTmFtZTogc3RyaW5nLCBmaWx0ZXI6IG1vbmdvREIuRmlsdGVyPG1vbmdvREIuQlNPTi5Eb2N1bWVudD4pIHtcclxuICAgIFxyXG4gICAgICAgICAgICB0cnkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGFiYXNlID0gdGhpcy5jbGllbnQuZGIodGhpcy5kYXRhYmFzZU5hbWUpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY29sbGVjdGlvbiA9IGRhdGFiYXNlLmNvbGxlY3Rpb24oY29sbGVjdGlvbk5hbWUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGxlY3Rpb24uZGVsZXRlT25lKGZpbHRlcik7XHJcblxyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1vbmdvRGJFcnJvcih7bWVzc2FnZTogYCR7ZXJyb3IubWVzc2FnZX0gLSBjb2xsZWN0aW9uTmFtZT0ke2NvbGxlY3Rpb25OYW1lfSwgZmlsdGVyPSR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyKX1gfSk7XHJcblxyXG4gICAgICAgICAgICB9ICBcclxuICAgIFxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBhc3luYyBkZWxldGVNYW55KGNvbGxlY3Rpb25OYW1lOiBzdHJpbmcsIGZpbHRlcjogbW9uZ29EQi5GaWx0ZXI8bW9uZ29EQi5CU09OLkRvY3VtZW50Pikge1xyXG4gICAgXHJcbiAgICAgICAgICAgIHRyeSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YWJhc2UgPSB0aGlzLmNsaWVudC5kYih0aGlzLmRhdGFiYXNlTmFtZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb2xsZWN0aW9uID0gZGF0YWJhc2UuY29sbGVjdGlvbihjb2xsZWN0aW9uTmFtZSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbGVjdGlvbi5kZWxldGVNYW55KGZpbHRlcik7XHJcblxyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1vbmdvRGJFcnJvcih7bWVzc2FnZTogYCR7ZXJyb3IubWVzc2FnZX0gLSBjb2xsZWN0aW9uTmFtZT0ke2NvbGxlY3Rpb25OYW1lfSwgZmlsdGVyPSR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyKX1gfSk7XHJcblxyXG4gICAgICAgICAgICB9ICBcclxuICAgIFxyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIHVwZGF0ZU9uZTxUIGV4dGVuZHMgbW9uZ29EQi5CU09OLkRvY3VtZW50PihcclxuICAgICAgICBjb2xsZWN0aW9uTmFtZTogc3RyaW5nLFxyXG4gICAgICAgIGZpbHRlcjogbW9uZ29EQi5GaWx0ZXI8VD4sXHJcbiAgICAgICAgdXBkYXRlOiBtb25nb0RCLlVwZGF0ZUZpbHRlcjxUPiB8IFBhcnRpYWw8VD4sXHJcbiAgICAgICAgb3B0aW9ucz86IG1vbmdvREIuVXBkYXRlT3B0aW9uc1xyXG4gICAgKTogUHJvbWlzZTxtb25nb0RCLlVwZGF0ZVJlc3VsdD4ge1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhYmFzZSA9IHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2VOYW1lKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBkYXRhYmFzZS5jb2xsZWN0aW9uPFQ+KGNvbGxlY3Rpb25OYW1lKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNldDogbW9uZ29EQi5VcGRhdGVGaWx0ZXI8VD4gPSB7ICRzZXQ6IHVwZGF0ZSB9IGFzIG1vbmdvREIuVXBkYXRlRmlsdGVyPFQ+O1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsZWN0aW9uLnVwZGF0ZU9uZShmaWx0ZXIsIHNldCwgb3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1vbmdvRGJFcnJvcih7bWVzc2FnZTogYCR7ZXJyb3IubWVzc2FnZX0gLSBjb2xsZWN0aW9uTmFtZT0ke2NvbGxlY3Rpb25OYW1lfSwgZmlsdGVyPSR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyKX0sIHVwZGF0ZT0ke0pTT04uc3RyaW5naWZ5KHVwZGF0ZSl9JHtvcHRpb25zID8gYCwgb3B0aW9ucz0ke0pTT04uc3RyaW5naWZ5KG9wdGlvbnMpfWA6IFwiXCIgfWB9KTtcclxuXHJcbiAgICAgICAgICAgIH0gIFxyXG5cclxuXHJcbiAgICB9XHJcblxyXG5cclxuICAgIGFzeW5jIHVwZGF0ZU9uZUJ5SWQ8VCBleHRlbmRzIG1vbmdvREIuQlNPTi5Eb2N1bWVudD4oXHJcbiAgICAgICAgY29sbGVjdGlvbk5hbWU6IHN0cmluZyxcclxuICAgICAgICBfaWQ6IHN0cmluZyxcclxuICAgICAgICB1cGRhdGU6IG1vbmdvREIuVXBkYXRlRmlsdGVyPFQ+IHwgUGFydGlhbDxUPixcclxuICAgICAgICBvcHRpb25zPzogbW9uZ29EQi5VcGRhdGVPcHRpb25zXHJcbiAgICApOiBQcm9taXNlPG1vbmdvREIuVXBkYXRlUmVzdWx0PiB7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBvYmplY3RJZCA9IG5ldyBtb25nb0RCLk9iamVjdElkKF9pZClcclxuICAgICAgICAgICAgY29uc3QgZmlsdGVyOiBtb25nb0RCLkZpbHRlcjxUPiA9IHsgX2lkOiBvYmplY3RJZCB9IGFzIG1vbmdvREIuRmlsdGVyPFQ+O1xyXG5cclxuICAgICAgICAgICAgdHJ5IHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhYmFzZSA9IHRoaXMuY2xpZW50LmRiKHRoaXMuZGF0YWJhc2VOYW1lKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSBkYXRhYmFzZS5jb2xsZWN0aW9uPFQ+KGNvbGxlY3Rpb25OYW1lKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNldDogbW9uZ29EQi5VcGRhdGVGaWx0ZXI8VD4gPSB7ICRzZXQ6IHVwZGF0ZSB9IGFzIG1vbmdvREIuVXBkYXRlRmlsdGVyPFQ+O1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBjb2xsZWN0aW9uLnVwZGF0ZU9uZShmaWx0ZXIsIHNldCwgb3B0aW9ucyk7XHJcblxyXG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcblxyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IE1vbmdvRGJFcnJvcih7bWVzc2FnZTogYCR7ZXJyb3IubWVzc2FnZX0gLSBjb2xsZWN0aW9uTmFtZT0ke2NvbGxlY3Rpb25OYW1lfSwgZmlsdGVyPSR7SlNPTi5zdHJpbmdpZnkoZmlsdGVyKX0sIHVwZGF0ZT0ke0pTT04uc3RyaW5naWZ5KHVwZGF0ZSl9JHtvcHRpb25zID8gYCwgb3B0aW9ucz0ke29wdGlvbnN9YDogXCJcIiB9YH0pO1xyXG5cclxuICAgICAgICAgICAgfSAgXHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBjbG9zZUNvbm5lY3Rpb24oKSB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQuY2xvc2UoKTtcclxuICAgIH1cclxuXHJcblxyXG5cclxufSJdfQ==